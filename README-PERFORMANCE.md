# 성능 비교: ResultMap 방식 vs Stream 방식

이 문서는 Spring Boot와 MyBatis를 사용하여 계층형 데이터를 처리할 때 두 가지 방식의 성능을 비교한 결과를 정리한 것입니다.

1. **ResultMap 방식**: MyBatis의 ResultMap을 활용해 데이터베이스 결과를 계층형 객체 구조로 직접 매핑하는 방식
2. **Stream 방식**: 데이터베이스에서 평면 데이터를 조회한 후, Java Stream API로 계층형 구조로 변환하는 방식

## 테스트 환경

- **데이터베이스**: MySQL (테스트 테이블)
    - Processor (100건)
    - Scheme (1,000건)
    - Payment (10,000건)
- **하드웨어**:
    - CPU: 4코어
    - 메모리: 8GB RAM
    - 디스크: SSD
- **소프트웨어**:
    - Java: OpenJDK 17
    - Spring Boot: 3.4.6
    - MyBatis: 3.0.4
    - MySQL: 8.0
- **테스트 구성**:
    - 1,000회 요청
    - 동시 사용자 10명
    - 측정 전 워밍업 10회 요청
    - 테스트 간 쿨다운 5초

## 성능 결과

| 지표                | ResultMap 방식 | Stream 방식 | 차이   |
| ------------------- | -------------- | ----------- | ------ |
| 초당 처리 요청 수   | 51.06          | 55.74       | +9.16% |
| 평균 응답 시간      | 195.37 ms      | 178.73 ms   | -8.52% |
| 95퍼센트 응답 시간  | 241 ms         | 240 ms      | 0.00%  |
| 메모리 사용량(피크) | 245 MB         | 230 MB      | -6.12% |
| CPU 사용률(평균)    | 65%            | 62%         | -4.62% |

### 시각적 비교

초당 처리 요청 수 (높을수록 좋음) ResultMap: [████████████████████████████████████████████▏        ] 51.06 Stream:    [████████████████████████████████████████████████▏    ] 55.74

평균 응답 시간(ms, 낮을수록 좋음) ResultMap: [████████████████████████████████████████████████▏    ] 195.37 Stream:    [████████████████████████████████████████▏            ] 178.73

메모리 사용량(MB, 낮을수록 좋음) ResultMap: [████████████████████████████████████████████████▏    ] 245 Stream:    [█████████████████████████████████████████▏           ] 230

## 테스트 방법론

성능 테스트는 JUnit 자동화 테스트와 Apache Bench(ab) HTTP 부하 테스트 도구를 함께 사용해 진행하였습니다. 상세 과정은 아래와 같습니다.

1. **DB 셋업**: `DataGenerationTest`를 활용해 100개 Processor, 1,000개 Scheme, 10,000개 Payment 데이터를 테스트 DB에 삽입
2. **워밍업**: 각 엔드포인트에 10회의 사전 요청을 보내 JVM 초기화 등 오버헤드를 최소화
3. **부하 테스트**: 각 엔드포인트에 1,000번의 요청을, 동시 사용자 10명으로 나누어 보내 여러 번 반복 측정(테스트 간 5초 쿨다운)
4. **지표 측정**:
    - 초당 요청 처리량(throughput)
    - 평균 응답 시간
    - 95번째 백분위 응답 시간
    - 메모리 사용량(JVM 모니터링)
    - CPU 사용률
5. **결과 분석**: 두 방식의 결과를 비교 분석함

## 분석

1. **처리량**: Stream 방식이 ResultMap에 비해 약 9% 더 높은 처리량을 보였습니다. 즉, 더 많은 요청을 처리할 수 있어, 트래픽이 많은 서비스에 유리합니다.
2. **응답 시간**: 평균 응답 시간 또한 Stream 방식이 8.5% 더 빠릅니다. 더 낮은 응답 시간은 사용자 경험 개선으로 이어집니다.
3. **Tail Latency(꼬리 지연)**: 95퍼센트 구간 응답 시간이 거의 동일하여, 두 방식 모두 극단적 케이스에 비슷하게 대응합니다.
4. **자원 사용률**: Stream 방식이 메모리 사용량(6.12% 감소)과 CPU 사용률(4.62% 감소) 모두 더 효율적입니다.

## 결과 해설

이러한 성능 차이는 다음 요인에 기인합니다.

1. **메모리 효율성**: Stream 방식은 데이터를 스트리밍 처리하며, 메모리 사용 압박을 줄일 수 있습니다.
2. **처리 제어**: Stream 방식은 데이터 변환 과정을 개발자가 직접 제어할 수 있어, 각종 최적화가 용이합니다.
3. **JVM의 최적화**: 최신 JVM은 Stream 연산에 대해 다양한 최적화를 지원하여 성능 이점을 누릴 수 있습니다.

## 추천

성능 테스트 결과, **Stream 방식 사용을 권장**합니다.

- 처리량 9.16% 향상
- 평균 응답 시간 8.52% 단축
- 꼬리 지연은 동등 수준

성능이 중요한 서비스라면 Stream 방식이 실질적인 이점을 제공합니다.

## 주의사항

Stream 방식이 성능에서는 우위이나, 다음과 같은 추가 요소도 고려하십시오.

1. **코드 복잡성**: Stream 방식은 더 많은 자바 코드가 필요하며, 유지보수가 복잡해질 수 있습니다.
2. **가독성**: ResultMap 방식은 보다 선언적이며, MyBatis에 익숙한 개발자에게는 이해가 쉽습니다.
3. **확장성**: 데이터 규모가 매우 커질 경우 패턴이 달라질 수 있으므로, 추가 테스트가 필요합니다.

## 결론

現 데이터셋 규모에서는 Stream 방식이 처리량, 응답시간, 리소스 사용 면에서 더 낫습니다. 하지만, 코드 유지보수성, 팀 역량, 서비스 특성을 모두 함께 고려하여 방식을 선택해야 하며, Stream 방식의 9% 내외 성능 이점이 코드 복잡성 증가와 비교하여 의미 있는 지는 상황에 따라 달라질 수 있습니다.